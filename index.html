<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>交通违规记录（最终版）</title>
<style>
body{margin:0;padding:12px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#f3f5f7;color:#111}
h2{margin:6px 0 12px 0;font-size:20px}
.page{display:none}
.page.visible{display:block}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
label{display:block;margin:6px 0 4px;font-size:14px}
input[type="text"], textarea {width:100%;box-sizing:border-box;padding:10px;border-radius:8px;border:1px solid #cfcfcf;font-size:16px}
button.big{width:100%;padding:14px;border-radius:12px;border:none;background:#007aff;color:#fff;font-size:18px;margin-top:8px}
button.ghost{background:#e9eef8;color:#0366d6}
textarea{resize:none}
.top-menu-btn{position:fixed;top:12px;right:12px;z-index:1000;}
.top-menu{position:fixed;top:56px;right:12px;display:none;z-index:1000;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);padding:8px;width:200px}
.top-menu button{display:block;width:100%;margin-bottom:8px}
@media (min-width:700px){body{padding:24px;max-width:720px;margin:0 auto}}
</style>
</head>
<body>

<!-- 右上角菜单按钮 -->
<div class="top-menu-btn">
  <button onclick="toggleTopMenu()" style="padding:8px;border-radius:8px;border:none;background:#007aff;color:#fff;font-size:18px">☰</button>
</div>
<div id="topMenu" class="top-menu" aria-hidden="true">
  <button onclick="pauseRecord()" style="background:#f0ad4e;color:#fff;padding:10px;border-radius:8px;border:none">暂停记录</button>
  <button onclick="resumeRecord()" style="background:#5cb85c;color:#fff;padding:10px;border-radius:8px;border:none">恢复记录</button>
  <button onclick="stopRecord()" style="background:#d9534f;color:#fff;padding:10px;border-radius:8px;border:none">停止并导出 CSV</button>
</div>

<!-- 页面：首页 -->
<div id="pageHome" class="page visible">
  <div class="card">
    <h2>开始观察</h2>
    <label>观察人代号：</label>
    <input id="observerId" type="text" placeholder="请输入观察人代号">

    <label>道路类型：</label>
    <div style="display:flex;gap:8px;margin-bottom:6px">
      <label><input name="roadtype" type="radio" value="十字路口" checked> 十字路口</label>
      <label><input name="roadtype" type="radio" value="T型路口"> T型路口</label>
      <label><input name="roadtype" type="radio" value="直线道路"> 直线道路</label>
    </div>

    <label>观察地点ID：</label>
    <input id="addrId" type="text" placeholder="例如 Site-01">
    <label>位置：</label>
    <input id="location" type="text" placeholder="例如 北向路口靠近红绿灯">

    <button class="big" onclick="startRecord()">开始记录</button>
  </div>
</div>

<!-- 拍照选择页 -->
<div id="pagePhotoConfirm" class="page">
  <div class="card">
    <h2>是否拍照？</h2>
    <button class="big" onclick="takePhotoThenMenu()">拍照</button>
    <button class="big ghost" onclick="skipPhotoThenMenu()">跳过</button>
  </div>
</div>

<!-- 一级菜单 -->
<div id="pageMenu1" class="page">
  <div class="card">
    <h2>选择一级违规行为</h2>
    <div id="primaryButtons"></div>
  </div>
</div>

<!-- 二级菜单 -->
<div id="pageMenu2" class="page">
  <div class="card">
    <h2>选择二级违规行为</h2>
    <div id="secondaryButtons"></div>
  </div>
</div>

<!-- 三级菜单 -->
<div id="pageMenu3" class="page">
  <div class="card">
    <h2>选择三级违规行为</h2>
    <div id="tertiaryButtons"></div>
  </div>
</div>

<!-- 多行为确认 -->
<div id="pageMultiBehavior" class="page">
  <div class="card">
    <h2>是否在同一违规ID下记录其他行为？</h2>
    <button class="big" onclick="goToNote(true)">是</button>
    <button class="big ghost" onclick="goToNote(false)">否</button>
  </div>
</div>

<!-- 笔记页面 -->
<div id="pageNote" class="page">
  <div class="card">
    <h2>添加备注（可留空）</h2>
    <textarea id="noteInput" rows="5" placeholder="可填写简短备注"></textarea>
    <button class="big" onclick="saveRecordAfterNote()">保存并下一条</button>
  </div>
</div>

<!-- 隐藏的 file input，用于调用相机/选图（必须由用户点击触发） -->
<input id="camera" type="file" accept="image/*" capture="environment" style="display:none">

<script>
/* ---------- 状态  --------- */
let records = [];
let violationID = "";
let observerId = "";
let roadType = "";
let addrId = "";
let locationText = "";
let pathStack = [];
let tempNote = "";
let tempPhotos = [];         // 存储 File 对象（或 data URL，如果你后续转换）
let continueSameViolationID = false;
let paused = false;

/* ---------- 行为定义（中文） ---------- */
const behaviorKeys = {
  rl: "闯红灯",
  helmet: "头盔",
  wrongway: "逆行",
  license: "号牌违章",
  road: "通行道路违规",
  load: "装载",
  distract: "干扰驾驶",
  waitpos: "等候位置",
  other: "其他行为",
  parking: "停车"
};

const behaviors = {
  rl: { "左转": ["立即闯灯", "等候后闯灯"], "直行": ["立即闯灯", "等候后闯灯"], "右转": ["干扰其他方向"] },
  helmet: { "完全包头盔": [], "运动头盔": [], "无头盔": [], "其他": [] },
  wrongway: { "常规道路逆行": [], "单行线逆行": [], "路口逆行": [] },
  license: { "遮挡": ["轻微遮挡", "完全遮挡"], "故意损坏": [], "无牌照": [], "其他": [] },
  road: { "违规行驶非机动车道": [], "违规行驶人行道": [], "违规行驶机动车道": ["不使用最右道通行", "驶入公交道", "不驶入最左侧车道左转掉头", "其他"] },
  load: { "超高": [], "超宽": [], "超长": [] },
  distract: { "使用手持设备": [] },
  waitpos: { "停止线后": [], "人行横道上": [], "路口其他区域": [] },
  other: { "鸣笛": [], "转弯不打信号灯": [] },
  parking: { "停入路侧停车位": [], "停入人行道": [], "堵塞出入口消防通道": [], "停在路肩": [] }
};

/* ---------- 页面显示控制 ---------- */
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('visible'));
  const el = document.getElementById(id);
  if (el) el.classList.add('visible');
}

/* ---------- 顶部菜单控制 ---------- */
function toggleTopMenu() {
  const menu = document.getElementById('topMenu');
  menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}
function pauseRecord() { paused = true; alert('记录已暂停'); document.getElementById('topMenu').style.display='none'; }
function resumeRecord(){ paused = false; alert('记录已恢复'); document.getElementById('topMenu').style.display='none'; }

/* ---------- 启动观察流程 ---------- */
function startRecord() {
  observerId = document.getElementById('observerId').value.trim();
  const radios = document.getElementsByName('roadtype');
  for (const r of radios) if (r.checked) { roadType = r.value; break; }
  addrId = document.getElementById('addrId').value.trim();
  locationText = document.getElementById('location').value.trim();

  if (!observerId) { alert('请填写观察人代号'); return; }
  violationID = 'VID-' + Date.now();
  // 跳转到拍照选择页
  showPage('pagePhotoConfirm');
}

/* ---------- 拍照或跳过 —— 注意：立即跳转（不等待 FileReader 异步） ---------- */
function takePhotoThenMenu() {
  const f = document.getElementById('camera');

  f.onchange = function (e) {
    tempPhotos = [];
    const files = e.target.files;
    if (files && files.length > 0) {
      // 保存文件对象（不在这里做 FileReader 转换），避免阻塞和兼容性问题
      for (let i = 0; i < files.length; i++) tempPhotos.push(files[i]);
    }
    // 清除 input 值，确保下次可触发
    try { f.value = ''; } catch (err) { /* 某些环境会抛错，忽略 */ }
    // 立即进入行为选择（兼容 iOS Safari）
    preparePrimary(); showPage('pageMenu1');
  };

  // 由用户手动触发相机/相册
  f.click();
}

function skipPhotoThenMenu() {
  tempPhotos = [];
  preparePrimary(); showPage('pageMenu1');
}

/* ---------- 渲染一级/二级/三级菜单 ---------- */
function preparePrimary() {
  const container = document.getElementById('primaryButtons');
  container.innerHTML = '';
  for (const key in behaviorKeys) {
    const btn = document.createElement('button');
    btn.className = 'big';
    btn.textContent = behaviorKeys[key];
    btn.onclick = function () { pathStack = [key]; prepareSecondary(key); showPage('pageMenu2'); };
    container.appendChild(btn);
  }
}

function prepareSecondary(primaryKey) {
  const container = document.getElementById('secondaryButtons');
  container.innerHTML = '';
  const secObj = behaviors[primaryKey] || {};
  for (const secKey in secObj) {
    const btn = document.createElement('button');
    btn.className = 'big';
    btn.textContent = secKey;
    btn.onclick = function () {
      pathStack = [primaryKey, secKey];
      const arr = secObj[secKey];
      if (Array.isArray(arr) && arr.length > 0) { prepareTertiary(primaryKey, secKey); showPage('pageMenu3'); }
      else { afterTertiarySelected(); }
    };
    container.appendChild(btn);
  }
}

function prepareTertiary(primaryKey, secKey) {
  const container = document.getElementById('tertiaryButtons');
  container.innerHTML = '';
  const arr = behaviors[primaryKey][secKey] || [];
  arr.forEach(item => {
    const btn = document.createElement('button');
    btn.className = 'big';
    btn.textContent = item;
    btn.onclick = function () { pathStack = [primaryKey, secKey, item]; afterTertiarySelected(); };
    container.appendChild(btn);
  });
}

/* ---------- 选择三级后流程：多行为确认 -> 笔记 -> 保存 ---------- */
function afterTertiarySelected() {
  showPage('pageMultiBehavior');
}

function goToNote(same) {
  continueSameViolationID = !!same;
  document.getElementById('noteInput').value = '';
  showPage('pageNote');
}

/* ---------- 保存记录（包含时间） ---------- */
function saveRecordAfterNote() {
  tempNote = document.getElementById('noteInput').value.trim();
  saveRecord();
}

function saveRecord() {
  if (paused) { alert('记录已暂停，无法保存'); return; }
  const now = new Date().toISOString();
  records.push({
    violationID,
    time: now,
    level1: pathStack[0] || '',
    level2: pathStack[1] || '',
    level3: pathStack[2] || '',
    observer: observerId,
    roadType: roadType,
    addrId: addrId,
    location: locationText,
    note: tempNote || '',
    photosCount: tempPhotos.length
    // 若需照片内容（Base64 或文件），可在此处用 FileReader 转换并保存
  });

  // 是否继续用同一 violationID（按用户在多行为确认页选择）
  if (!continueSameViolationID) violationID = 'VID-' + Date.now();

  // 重置临时变量，返回拍照页准备下一条
  pathStack = []; tempNote = ''; tempPhotos = [];
  showPage('pagePhotoConfirm');
}

/* ---------- CSV 导出（包含时间与三级列） ---------- */
function stopRecord() {
  if (records.length === 0) { alert('没有记录可导出'); return; }

  // 生成 CSV，按列：违规ID, 时间, 一级, 二级, 三级, 观察人, 道路类型, 地址ID, 位置, 备注, 照片数
  let csv = "违规ID,时间,一级行为,二级行为,三级行为,观察人,道路类型,地址ID,位置,备注,照片数\n";
  for (const r of records) {
    // 对双引号做转义
    const safe = v => String(v || '').replace(/"/g, '""');
    csv += `"${safe(r.violationID)}","${safe(r.time)}","${safe(r.level1)}","${safe(r.level2)}","${safe(r.level3)}","${safe(r.observer)}","${safe(r.roadType)}","${safe(r.addrId)}","${safe(r.location)}","${safe(r.note)}","${safe(r.photosCount)}"\n`;
  }

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'traffic_records.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert('CSV 已生成并下载（或在移动设备提示保存）');
  // 选项：导出后是否清空 records？这里不自动清空，客户可手动刷新页面清除
}

/* ---------- 页面首次加载：确保首页可见 ---------- */
document.addEventListener('DOMContentLoaded', function () {
  showPage('pageHome');
});
</script>
</body>
</html>
